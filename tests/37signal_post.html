<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta property="og:image" content="http://37signals.com/images/logo_bigmark.png" />
  <meta property="og:site_name" content="A design and usability blog: Signal vs. Noise (by 37signals)"/>
  <meta property="fb:admins" content="555561089" />
  <title>How key-based cache expiration works - (37signals)</title>
  <script src="http://37signals.com/svn/javascripts/all.js?1329486949" type="text/javascript"></script>

  <script type="text/javascript">var _sf_startpt=(new Date()).getTime()</script>

  <link href="http://37signals.com/svn/stylesheets/screen.css?1329486949" media="screen" rel="stylesheet" type="text/css" />
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/37signals/beMH" />
</head>

<body class="perma">



<div id="Container">

    <div id="Masthead" style="margin-bottom: 0;">

      <a href="http://37signals.com" class="image"><img alt="37signals logo" height="22" src="http://37signals.com/svn/images/37slogo-trans.gif?1249930973" width="100" /></a>
      <h1>This is <a href="http://37signals.com/svn/">Signal vs. Noise</a>, a weblog by 37signals about design, business, experience, simplicity, the web, culture, and more. Established 1999 in Chicago. <a href="http://twitter.com/37signals" style="font-weight: normal; text-decoration: underline;">Follow us on Twitter</a> for more information on our products.</h1>
    </div>


<div class="jobInclude">
  <table>

  <tr>
    <td align="right" nowrap><h2>Jobs:</h2></td>
    <td>
      <script src="http://jobs.37signals.com/jobs/random.js" type="text/javascript"></script>
      See more on our <a href="http://jobs.37signals.com">Job Board</a>.
    </td>
  </tr>

  </table>
</div>


  <div id="Content">
    

<div class="post"  id="article_3113">
  
    <div class="post_header" id="article_3113">

  <h2>
    
    <a href="http://37signals.com/svn/posts/3113-how-key-based-cache-expiration-works">How key-based cache expiration works</a>

    <span class="nobreak">
      <span class="author">David</span>
      
      <span class="date">Feb 19</span>
      
    </span>
  </h2>

  <h3>
    

    <span id="comment_activity" class="comment_activity"><a href="http://37signals.com/svn/posts/3113-how-key-based-cache-expiration-works?43#comments">43 comments</a> Latest by Oleh</span>

  </h3>
</div>

<blockquote>There are only two hard things in Computer Science: cache invalidation and naming things &mdash; Phil Karlton</blockquote>

	<p>Doing cache invalidation by hand is an incredibly frustrating and error-prone process. You&#8217;re very likely to forget a spot and let stale data get served. That&#8217;s enough to turn most people off russian-doll caching structures, <a href="http://37signals.com/svn/posts/3112-how-basecamp-next-got-to-be-so-damn-fast-without-using-much-client-side-ui">like the one we&#8217;re using for Basecamp Next</a>.</p>


	<p>Thankfully there&#8217;s a better way. A much better way. It&#8217;s called key-based cache expiration and it works like this:</p>

    <span id="extended"><ol><li><b>The cache key is the fluid part and the cache content is the fixed part.</b> A given key should always return the same content. You never update the content after it&#8217;s been written and you never try to expire it either.</li>

<li style="margin-top:20px"><b>The key is calculated in lock-step with the object that&#8217;s represented in the content.</b> This is commonly done by making a timestamp part of the key, so for example [class]/[id]-[timestamp], like todos/5-20110218104500 or projects/15-20110218104500, which is what Active Record in Rails does by default when you call #cache_key.</li>

<li style="margin-top:20px"><b>When the key changes, you simply write the new content to this new key.</b> So if you update the todo, the key changes from todos/5-2011021810<i>4500</i> to todos/5-2011021810<i>5545</i>, and thus the new content is written based on the updated object.</li>

<li style="margin-top:20px"><b>This generates a lot of cache garbage.</b> Once we&#8217;ve updated the todo, the old cache will never get read again. The beauty of that system is that you just don&#8217;t care. Memcached will automatically evict the oldest keys first when it runs out of space. It can do this because it keeps track of when everything was last read.</li>

<li style="margin-top:20px"><b>You deal with dependency structures by tying the model objects together on updates.</b> So if you change a todo that belongs to a todolist that belongs to a project, you update the updated_at timestamp on every part of the chain, which will automatically then update the cache keys based on these objects. In Rails, you can declare it like this:</li>

	<p><img src="http://s3.amazonaws.com/37assets/svn/787-nested-chain-485-2-1.png" alt="" /></p>


<li style="margin-top:20px"><b>The caching itself then happens in the views based on partials rendering the objects in question.</b> This can be neatly nested like below where each call to <code>cache</code> will call #cache_key on the elements of the passed-in array. So in the first case, the cache key ends up being something like v5/projects/5-20110219102600. That key is then updated when the object is updated as described in the process above, and the proper cache is always fetched.</li>

<img src="http://s3.amazonaws.com/37assets/svn/785-nested-caching-485.png" alt="" />
</ol>

	<p>This process makes it trivial to implement caching schemes and trust that you&#8217;re never going to serve stale data. There&#8217;s no messy cleanup to deal with since you&#8217;re not obligated to track down every spot that might update an object. The updated_at field that&#8217;s part of all the caching keys automatically takes care of that for you, wherever that update came from.</p></span>
  
</div>

  <div class="share">
    <div id="tweet-this">

      <a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="37signals" data-related="37signals/staff:37signals staff">Tweet</a>
      <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    </div>
    <script src="http://connect.facebook.net/en_US/all.js#xfbml=1"></script><fb:like href="" layout="button_count" show_faces="false" width="450" font="" style="float: left; margin-left: 130px; margin-top: -20px;"></fb:like>
  </div>

  <div class="comments" id="comments_section">
    <div id="comments">

      <div class="end_of_post_ad">
        <strong>Looking for a job? Got a position to fill?</strong> Check out the <a href="http://jobs.37signals.com">Job Board</a>.
        <hr noshade><strong>Got a web design project in mind? </strong> <a href="http://sortfolio.com">Find a web designer on Sortfolio</a>. Browse by visual style, portfolio, budget, and geographic location.
        <hr noshade>Over 1 million people use <strong><a href="http://37signals.com">37signals' simple web-based software</a></strong> to collaborate on projects, track contacts, and organize their business with an intranet. 
      </div>

      <div class="commentsbg" id="commentsbg">
  <h2>43 comments so far</h2>
  <div id="comment_72603" class="comment">
  <h3>
        <span class="author"><a href="http://www.hashref.com" only_path="true" rel="nofollow">Xavier Noria</a></span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>Just for the record, if you are using Redis as cache store with default settings, then you need to mark these keys as volatile so that Redis know it can get rid of them. See details in http://antirez.com/post/redis-as-LRU-cache.html.</p>
  </div>
</div>
<div id="comment_72604" class="comment">
  <h3>
        <span class="author">Justin Ko</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>Could you use &#8220;touch&#8221; to be more semantic?</p>


	<p>todo.update_attributes(content: &#8220;New stuff&#8221;).touch</p>
  </div>

</div>
<div id="comment_72605" class="comment author_comment">
  <h3>
        <span class="author">DHH</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>Justin, my bad, left a stray save in there. #update_attributes already calls save and saving is all you need to trigger the touching chain.</p>

  </div>
</div>
<div id="comment_72606" class="comment">
  <h3>
        <span class="author">Denis</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>Do these v1, v3 and v5 represent the versions of the partials? And you will update v1 to v2 when todo partial markup changes for example.</p>

  </div>
</div>
<div id="comment_72607" class="comment author_comment">
  <h3>
        <span class="author">DHH</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>Denis, exactly. You bump the version when you change what goes into the cache (either from a change in the partial, the model, or a helper used to generate the content).</p>

  </div>
</div>
<div id="comment_72608" class="comment">
  <h3>
        <span class="author">Justin Ko</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p> DHH , oh God and even my example code is wrong!  LOL  &#8211; &#8220;update_attributes&#8221; will return true. Can we delete both our comments and act like this never happened? ;)</p>

  </div>
</div>
<div id="comment_72609" class="comment">
  <h3>
        <span class="author">Ustun Ozgur</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>When do you generate the new html content exactly? When the object is saved, or when the keys are first requested?</p>


	<p>You seem to say the former, so how do you know which keys belong to an object, that is, if there are more than one html snippets which depend on the object?</p>
  </div>
</div>
<div id="comment_72610" class="comment author_comment">
  <h3>
        <span class="author">DHH</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>The cache is generated on the first request. In the code blocks in step 6, we&#8217;ll run what&#8217;s inside the block if there&#8217;s no cache content for the cache key generated by the parameters we pass to #cache. After the first run, that content is then saved.</p>


	<p>You can have multiple caches depend on the same object by mentioning that object in multiple cache keys. When you update the object, every cache key that depends on that object is bumped and they all have to regenerate their content.</p>
  </div>
</div>

<div id="comment_72611" class="comment">
  <h3>
        <span class="author">Ustun Ozgur</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>@DHH What about some predictive (preemptive) caching? Would that work at all?</p>

	<p>I&#8217;m thinking something along the lines: If a user visits the site very frequently, add him to the list of people whose pages will be pre-generated etc.</p>
  </div>
</div>
<div id="comment_72612" class="comment">
  <h3>
        <span class="author">stjernstrom</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>I really like this. Seems like the key is:</p>


	<p><strong>&#8220;The cache key is the fluid part and the cache content&#8221;</strong></p>
  </div>
</div>
<div id="comment_72613" class="comment">
  <h3>

        <span class="author">Koz</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>The more common name for this caching strategy is generational caching and it&#8217;s definitely easier. Declaring the cache dependencies at the call/definition site rather than in weird observers.</p>


	<p>One gotcha you can hit is with the way the slab allocator works in memcached. You can end up with a large amount of ram used ineffectively especially if you combine generational caches with  TTL  values in the same cache family.</p>


	<p>Evan, formerly of twitter, released a fancy tool and great blog post a while back. <a href="http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/">I tracked down the initial blog post</a> for those who might be interested.</p>
  </div>
</div>
<div id="comment_72614" class="comment">
  <h3>
        <span class="author">Glen Mailer</span> 
    <span class="date">19 Feb 12</span>

  </h3>

  <div class="comment_body">
    <p>Is there any caching of the model methods themselves being done? While this speeds up the  HTML  generation hugely, it still requires you to get the relevant objects out of the DB to calculate the key, which may or may not require a complex query.</p>


	<p>Or am I missing something?</p>
  </div>
</div>
<div id="comment_72616" class="comment">

  <h3>
        <span class="author">Jamie</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>This is a great write up. But it looks like &#8216;touch&#8217; only works with belongs_to. What if you wanted to do it the other way around with has_many ?</p>


	<p>For argument&#8217;s sake let&#8217;s say you had a partial showing a Todo with its parent Todolist name. If you updated the Todolist name, the cached Todo partial would be stale as Todolist can only touch its parent rather than its children. (child-touching jokes at the ready&#8230;)</p>
  </div>
</div>
<div id="comment_72617" class="comment">
  <h3>
        <span class="author">Jamie</span> 
    <span class="date">19 Feb 12</span>

  </h3>

  <div class="comment_body">
    <p>Or a better example for my question above:</p>


	<p>Todo belongs_to User
User has_many Todo</p>


	<p>Partial shows:</p>


	<p>{{todo}} assigned to {{username}}</p>


	<p>If I change my username, all the todo partials will be stale because User has_many Todo and can&#8217;t touch like belongs_to.</p>
  </div>
</div>
<div id="comment_72618" class="comment">
  <h3>

        <span class="author">KTB</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>Could you elaborate on how you get stuff from the cache?
Ie. if I want to fetch the ToDo with the id 5, how do I get the correct cache key?</p>
  </div>
</div>
<div id="comment_72619" class="comment">

  <h3>
        <span class="author">Laszlo Korte</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>You could put the user object into the cache key:</p>


	<p>&lt;% cache [&#8216;v1&#8217;, todo, todo.user] do %&gt;</p>
  </div>
</div>
<div id="comment_72620" class="comment">
  <h3>
        <span class="author">stjernstrom</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>Would be really neat if we could get a checksum from a Proc</p>
  </div>
</div>
<div id="comment_72621" class="comment">
  <h3>
        <span class="author"><a href="http://elicolner.tumblr.com" only_path="true" rel="nofollow">Eli</a></span> 
    <span class="date">19 Feb 12</span>

  </h3>

  <div class="comment_body">
    <p>Do you have any locks and if so is lock contention an issue with this scheme?</p>
  </div>
</div>
<div id="comment_72622" class="comment">
  <h3>
        <span class="author">Jamie</span> 
    <span class="date">19 Feb 12</span>

  </h3>

  <div class="comment_body">
    <p>@Laszlo Actually that did cross my mind after I posted, but then you trigger another DB read, reducing the usefulness of the cache.</p>
  </div>
</div>
<div id="comment_72623" class="comment">
  <h3>
        <span class="author">Sweam</span> 
    <span class="date">19 Feb 12</span>

  </h3>

  <div class="comment_body">
    <p>@Glen Mailer, exactly what I thought: this still is hitting the DB at full speed. Maybe they only cache complex queries? I&#8217;d love to hear an explantation!</p>
  </div>
</div>
<div id="comment_72624" class="comment">
  <h3>
        <span class="author"><a href="http://runningblind.com" only_path="true" rel="nofollow">Josh Goebl</a></span> 
    <span class="date">19 Feb 12</span>

  </h3>

  <div class="comment_body">
    <p>Glen Mailer:  It&#8217;s not as bad as you think&#8230; if the project hasn&#8217;t changed then none of the todolists or todos have to be loaded to calculate the project cache_key&#8230; if only one todo has been changed then only the top level todo lists have to be loaded (to recache the project), and only all the todos inside a single todo list (to recache that todo list).  Still a very small amount of the full dataset.</p>
  </div>
</div>

<div id="comment_72625" class="comment">
  <h3>
        <span class="author"><a href="http://runningblind.com" only_path="true" rel="nofollow">Josh Goebel</a></span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>Sweam: See my response to Glen.  But in my experience on complex pages DB access is only 20-30% of the entire response time anyways&#8230; so even if  ALL  the db had to be loaded to determine if the cache was valid that would still be a 70-80% speed increase.</p>

  </div>
</div>
<div id="comment_72626" class="comment">
  <h3>
        <span class="author"><a href="http://itnig.net" only_path="true" rel="nofollow">Roger campos</a></span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>Just to add my 2 cents, the expiration key based on the updated_at is precise up to the second, so it might happen that your integration tests fail due to them beeing too fast. Maybe you need to add some sleep to make sure your tests gets the new version.</p>

  </div>
</div>
<div id="comment_72628" class="comment">
  <h3>
        <span class="author"><a href="http://onesandzeros.posterous.com/" only_path="true" rel="nofollow">Sofia Cardita</a></span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>@Glen Mailer In this scheme you stil hit the db for the top object of the chain, in this case, projects. But you could keep a cache for the project keyed by project id only, which would have the timestamp (which would also have to invalidated when the updated_at field changes in the project model). Then, just get the cache for the project by the project id, from there you get the timestamp and can fetch the rest of the cache objects.</p>

  </div>
</div>
<div id="comment_72629" class="comment">
  <h3>
        <span class="author">Manuel F. Lara</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>I don&#8217;t know about Ruby or Rails so maybe this is done automatically and my question is stupid, but:</p>


	<p>If your cache is projects/15-20110218104500 for example, where do you store that timestamp? Is there another cache like projects/15-time where you always have the last timestamp for the projects list? Like you just update this cached value when something changes, and this is what triggers everything, since you use that value to construct the actual cache with the content (use that value as part of the key for the projects/15-$timestamp?</p>
  </div>
</div>
<div id="comment_72630" class="comment">
  <h3>
        <span class="author">Manuel F. Lara</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>In my previous comment, when I said &#8220;the last timestamp for the projects list&#8221; I meant &#8220;the last timestamp for that particular project&#8221;, since I guess &#8220;projects/15-$timestamp&#8221; is the cache block for one project, not a list of projects.</p>
  </div>
</div>

<div id="comment_72631" class="comment">
  <h3>
        <span class="author"><a href="http://pensandoazure.wordpress.com/" only_path="true" rel="nofollow">Fernando Correia</a></span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>As Evan Weaver pointed out (http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/), to efficiently use the generational key technique, you should use distinct pools for the generational keys and for the direct keys.</p>
  </div>

</div>
<div id="comment_72632" class="comment">
  <h3>
        <span class="author">Ed</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>I could remember this whole similar caching thing being done in Twitter. But yet i couldn&#8217;t find the article from google.</p>

  </div>
</div>
<div id="comment_72633" class="comment">
  <h3>
        <span class="author">tobi</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>This scheme is even mostly transactionally consistent meaning reads will (mostly) see an atomic view of the word. But not always because the old version&#8217;s cache items might get partially evicted so a part of the request gets served from new data and a part from old data.</p>

  </div>
</div>
<div id="comment_72634" class="comment">
  <h3>
        <span class="author">Sweam</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>@Josh Goebel, I understand it a bit better now, but you agree that all the database queries are executed? If only some of them are executed I would like to know how that&#8217;s possible, because that&#8217;s outside the scope of fragment caching as far I&#8217;m aware of?</p>

  </div>
</div>
<div id="comment_72635" class="comment">
  <h3>
        <span class="author">Hank</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>All</p>


	<p><b>Not to sound snarky, but isn&#8217;t this how everyone has always done web based caching?</b></p>
  </div>
</div>
<div id="comment_72636" class="comment">
  <h3>
        <span class="author">Manuel F. Lara</span> 
    <span class="date">19 Feb 12</span>

  </h3>

  <div class="comment_body">
    <p>@Hank: not at all, there are different ways of caching. You can cache stuff for X amount of time (a few hours), you can cache things and then delete those cache keys when something gets updated, etc. Depends on the case and of the methodology you want to use.</p>
  </div>
</div>
<div id="comment_72637" class="comment">
  <h3>
        <span class="author">Hank</span> 
    <span class="date">19 Feb 12</span>

  </h3>

  <div class="comment_body">
    <p>All</p>


	<p>It&#8217;s important for everyone to <a href="http://news.ycombinator.com/item?id=3609447">read this post at HackerNews</a> on this topic:</p>


<blockquote>
	<blockquote>
	<p>&#8220;I work on memcache at Facebook&#8230;but the reality is that this just doesn&#8217;t solve all possible cache consistency problems. Namely, how do you deal with racing writes where the clocks are skewed? How do you deal with multiple copies of the same data in different caches (different data centers, for example). What about axe-murdering your top level db because that data is inherently uncacheable using this scheme?&#8221;</p>

	</blockquote>



</blockquote>




	<p>Not too many people know memcache better, and how to properly use it, than Facebook.</p>


	<p>So if you plan to implement  DHH  approach, be forewarned that even his approach <em>&#8220;doesn&#8217;t solve all possible cache consistency problems&#8221;</em>.</p>
  </div>

</div>
<div id="comment_72639" class="comment author_comment">
  <h3>
        <span class="author">DHH</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>Hank, correct. If you are Facebook scale, you need to deal with problems the rest of us will rarely ever see (like cross data center race conditions). Good thing that they have smart and capable people working on those problems. For the rest of us, we can be happy to use what&#8217;s available today.</p>

  </div>
</div>
<div id="comment_72640" class="comment">
  <h3>
        <span class="author"><a href="http://www.terlici.com" only_path="true" rel="nofollow">Stefan</a></span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>What is the advantage of having the key change instead of the content?</p>


	<p>How do you know what is the new key once it changes?</p>
  </div>
</div>
<div id="comment_72641" class="comment">
  <h3>
        <span class="author">Hank</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>@DHH</p>


<blockquote>
	<blockquote>
	<p>&#8220;Hank, correct. If you are Facebook scale, you need to deal with problems the rest of us will rarely ever see (like cross data center race conditions).&#8221;</p>

	</blockquote>



</blockquote>




	<p>No, that&#8217;s not what he/she is saying.</p>


	<p>I obviously can&#8217;t speak on behalf of the HackerNews/Facebook-employee but the takeaway I learned from his/her comment was that if your caching solution is distributed over <em>more than a single cache server</em>, which <a href="http://37signals.com/svn/posts/3090-basecamp-nexts-caching-hardware">yours is</a> &#8211; the implementation approach you have designed and outlined in this post is flawed.</p>

  </div>
</div>
<div id="comment_72643" class="comment">
  <h3>
        <span class="author">Ryan Sharp</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>http://plan9.bell-labs.com/sys/doc/venti/venti.html</p>

  </div>
</div>
<div id="comment_72644" class="comment">
  <h3>
        <span class="author">Ryan</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>@Hank</p>


	<p>You can take your posturing elsewhere. The old &#8220;Facebook says so&#8221; cargo-cult garbage is getting quite tired now.</p>


	<p>Facebook is just one problem that calls for the collaboration of many talented engineers. It&#8217;s not a secret society of geniuses, whose approval you can use to win arguments.</p>


	<p>Take a nap, champ.</p>

  </div>
</div>
<div id="comment_72645" class="comment">
  <h3>
        <span class="author">Hank</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>@Ryan</p>


	<p>Facebook does more active development on memcache than  ANYONE ELSE .</p>


	<p>So, like I said in my original comment, when I encountered the post on HackerNews advising against  DHH  implementation, I found it worthwhile to share that post.</p>


	<p>I&#8217;m done commenting on this topic.</p>

	<p>All I was trying to do was help point out concern raised by experts in this technology. Nothing more.</p>
  </div>
</div>
<div id="comment_72646" class="comment">
  <h3>
        <span class="author"><a href="http://ilikestuffblog.com/" only_path="true" rel="nofollow">Brian Morearty</a></span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>It would be wonderful if Rails had a simple set of assertions built-in, or as a gem, to test fragment cache expectations for integration tests. I haven&#8217;t found such assertions in the wild and have thought about writing a gem with them but am putting it out there in case anyone else wants to. E.g.,</p>


	<p>1. Get a page.
2. Get it again in a different session&#8212;assert that a fragment cache was used.
3. Modify an object that&#8217;s used in the fragment.
4. Get the page again&#8212;assert that the cache was not used.</p>
  </div>

</div>
<div id="comment_72647" class="comment">
  <h3>
        <span class="author">Scott</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>Brilliant in its ease and simplicity.  I can&#8217;t think of a reason to continue with the traditional approach where the cache key is fixed.  Thanks for sharing.</p>

  </div>
</div>
<div id="comment_72648" class="comment">
  <h3>
        <span class="author"><a href="http://franxman.com" only_path="true" rel="nofollow">glenn</a></span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>As near as I can tell, this technique assumes that your storage system is fast ( because it has to pre-fetch the objects in order to create the keys ) and that your templates are slow ( because it is caching the results of the use of those objects ).</p>


	<p>Is that right?</p>
  </div>
</div>
<div id="comment_72649" class="comment">
  <h3>
        <span class="author">Oleh</span> 
    <span class="date">19 Feb 12</span>
  </h3>

  <div class="comment_body">
    <p>@DHH
For me the most interesting part is bumping template version.
I&#8217;m curious whether you have some automation, or manually update every time?</p>


	<p>Not sure if it&#8217;s possible, but the idea of having git pre-commit hook for handling this seems good to me.</p>
  </div>
</div>

</div> <!-- commentsbg -->
    </div>
    
          <div id="comment_form">
        

  <h2>Post a comment</h2>


<div id="new_comment">
  <form action="http://37signals.com/svn/posts/3113-how-key-based-cache-expiration-works/comments" method="post" onsubmit="$(this).down(&quot;input[type=submit]&quot;).disabled = true; new Ajax.Request('http://37signals.com/svn/posts/3113-how-key-based-cache-expiration-works/comments', {asynchronous:true, evalScripts:true, parameters:Form.serialize(this)}); return false;">
    <dl>
      <dt class="inline"><label for="author"><strong>Name</strong></label></dt>

      <dd class="inline"><input id="comment_name" name="comment[name]" size="30" tabindex="1" type="text" /></dd>

      <dt class="inline"><label for="email">Email</label></dt>
      <dd class="inline"><input id="comment_email" name="comment[email]" size="30" tabindex="2" type="text" /></dd>

      <dt class="inline"><label for="url">URL</label></dt>
      <dd class="inline"><input id="comment_url" name="comment[url]" size="30" tabindex="3" type="text" /></dd>

      

      <dt class="textarealabel"><label for="text"><strong>Comments</strong></label> <span>[ Basic HTML is allowed (a href, strong, em, blockquote). ]</span></dt>

      <dd><textarea cols="24" id="comment_comment" name="comment[comment]" rows="10" tabindex="5"></textarea><p id="caveat" style="font-size: 10px;"><strong>NOTE:</strong> We'd rather not moderate, but off-topic, blatantly inflammatory, or otherwise inappropriate or vapid comments may be removed. Repeat offenders will be banned from commenting. Let's add value. Thank you.</p></dd>

      <p class="submit">
              <input name="commit" tabindex="6" type="submit" value="Post this comment" /> <span>or</span> <a href="#" onclick="$(&quot;new_comment&quot;).addClassName(&quot;busy&quot;); new Ajax.Request('http://37signals.com/svn/posts/3113-how-key-based-cache-expiration-works/comments/preview', {asynchronous:true, evalScripts:true, parameters:$(this).up('form').serialize()}); return false;">Preview</a>
            </p>

    </dl>
  </form>

  <div id="new_comment_preview"></div>
</div>

      </div>
      </div> <!-- comments -->

  </div>

  
  <div class="sidebar">
    <div class="ad">
  <a href="http://coudal.com/deck/" class="image"><img alt="Ads via the Deck" height="5" src="http://37signals.com/svn/images/thedeck.gif?1249930978" style="margin-bottom: 10px;" width="69" /></a><br />
  <script type="text/javascript">
  //<![CDATA[
  (function(id) {
    document.write('<script type="text/javascript" src="' +
      'http://connect.decknetwork.net/deck' + id + '_js.php?' +
      (new Date().getTime()) + '"></' + 'script>');
  })("SV");
  //]]>
  </script>
</div>

<div class="feed">
  <p><a href="http://feeds.feedburner.com/37signals/beMH" class="image">
    <img alt="Grab our RSS feed" height="37" src="http://37signals.com/svn/images/btn_rss.png?1281629992" width="147" />
  </a></p>

  <a class="image" href="http://feeds.feedburner.com/37signals/beMH"><img src="http://feeds.feedburner.com/~fc/37signals/beMH?bg=F7F5E7&fg=444444&anim=0" height="26" width="88" style="border:0" alt="Feedstats" /></a>
</div>

<div class="categories">
  <h2>Filter posts by topic</h2>
  <ul>
    
      <li><a href="http://37signals.com/svn/business">Business</a></li>
    
      <li><a href="http://37signals.com/svn/design">Design</a></li>
    
      <li><a href="http://37signals.com/svn/programming">Programming</a></li>

    
      <li><a href="http://37signals.com/svn/support">Support</a></li>
    
      <li><a href="http://37signals.com/svn/sysadmin">Sysadmin</a></li>
    
      <li><a href="http://37signals.com/svn/writing">Writing</a></li>
    
    <li><a href="http://37signals.com/svn/popular">The best of Signal vs. Noise</a></li>
    <li><a href="http://37signals.com/svn/archives">See all posts</a></li>
  </ul>

  <form method="get" action="http://www.google.com/search">
    <input type="text" name="q" style="width:150px; padding: 3px;" />
    <input type="submit" value="Search" />
    <input type="hidden" name="sitesearch" value="37signals.com/svn" />
  </form>
</div>

<div id="twitter_div" style="border-bottom: 1px dotted #cecece; margin-bottom: 10px; padding-bottom: 10px;">
  <a href="http://twitter.com/37signals">Follow us on</a>

  <a href="http://twitter.com/37signals">
    <img align="absmiddle" alt="twitter" border="0" height="18" src="http://37signals.com/svn/images/little-twitter-logo.png?1249930974" style="margin-top: -5px" width="77" />
  </a>
  <div id="tweet">
    <p>Loading Twitter posts...</p>
  </div>
</div>

<div class="products">
  <h2>Books from 37signals</h2>

  <h3>
    <a href="http://37signals.com/rework/" title="REWORK"><img src="http://37signals.com/images/blog/crumpled_paper_sm.png" alt="REWORK" width="39" height="51" align="left"></a>
    <a href="http://37signals.com/rework/" title="REWORK">REWORK</a>
  </h3>
  <p>The new business book from 37signals shows you how to build, run, and grow (or not grow) a business.</p>

  <h3>
    <a href="https://gettingreal.37signals.com" title="Getting Real"><img align="left" alt="Getting Real" height="51" src="http://37signals.com/svn/images/logo-small-grbook.gif?1249930975" width="39" /></a>

    <a href="https://gettingreal.37signals.com" title="Getting Real">Getting Real</a>
  </h3>
  <p>The smarter, faster, easier way to build a successful web application. 171 page PDF ($19) or paperback ($25). Buy it now.</p>
  
  <h2>Web-Based Software by 37signals</h2>
  <h3>
    <a href="http://basecamphq.com/?source=svn+sidebar" title="Basecamp project management"><img align="left" alt="Basecamp" height="32" src="http://37signals.com/svn/images/logo-small-basecamp.gif?1249930974" width="39" /></a>
    <a href="http://basecamphq.com/?source=svn+sidebar" title="Basecamp, project management">Basecamp project management</a>

  </h3>
  <p>Everyone's favorite web-based project management tool. Easy, fast, elegant. Free trial.</p>

  <h3>
    <a href="http://highrisehq.com/?source=svn+sidebar" title="Highrise shared contact manager"><img align="left" alt="Highrise" height="32" src="http://37signals.com/svn/images/logo-small-highrise.png?1249930975" width="39" /></a>
    <a href="http://highrisehq.com/?source=svn+sidebar" title="Highrise shared contact manager">Highrise simple CRM</a>
  </h3>
  <p>Keep track of who your business talks to, what was said, and what to do next. Free trial.</p>

  <h3>
    <a href="http://campfirenow.com" title="Campfire group business chat"><img align="left" alt="Campfire" height="33" src="http://37signals.com/svn/images/logo-small-campfire.gif?1249930974" width="39" /></a>
    <a href="http://campfirenow.com" title="Campfire group business chat">Campfire group business chat</a>
  </h3>
  <p>Simple and easy web-based group chat for business has finally arrived. Try it free today.</p>

  <h3>
    <a href="http://backpackit.com" title="Backpack information manager"><img align="left" alt="Backpack" height="32" src="http://37signals.com/svn/images/logo-small-backpack.gif?1249930974" width="39" /></a>

    <a href="http://backpackit.com" title="Backpack information manager">Backpack information manager</a>
  </h3>
  <p>Gather your ideas, to-dos, notes, photos &amp; files online. Set email and mobile reminders. Try free!</p>

  <h3>
    <a href="http://writeboard.com" title="Writeboard collaborative writing"><img align="left" alt="Writeboard" height="32" src="http://37signals.com/svn/images/logo-small-writeboard.gif?1249930976" width="39" /></a>
    <a href="http://writeboard.com" title="Writeboard collaborative writing">Writeboard collaborative writing</a>

  </h3>
  <p>Write, share, revise, compare. Sharable web-based text documents with simple version control.</p>

  <h3>
    <a href="http://tadalist.com" title="Ta-da List, to-do list manager"><img align="left" alt="Ta-da List" height="32" src="http://37signals.com/svn/images/logo-small-tada.gif?1249930976" width="39" /></a>
    <a href="http://tadalist.com" title="Ta-da List, to-do list manager">Ta-da List, to-do list manager</a>
  </h3>
  <p>The web's simplest, fastest, and most useful to-do list manager. Get things done. Free, 10 second signup.</p>

  <h3>
    <a href="http://rubyonrails.org" title="37signals Ruby on Rails framework"><img align="left" alt="Ruby on Rails" height="50" src="http://37signals.com/svn/images/logo-small-rails.gif?1249930975" width="39" /></a>
    <a href="http://rubyonrails.org" title="37signals Ruby on Rails framework">Ruby on Rails</a>
  </h3>
  <p>For developers we present our powerful yet simple open-source web application framework. Make coding easier on yourself.</p>

  <form action="http://37signals.cmail1.com/.aspx/s/472/" method="post">
    <h2>Subscribe to our newsletter</h2>

    <p>Hear about new products, features, promos, discounts, &amp; more. Sent about once a month. <strong>Enter your email below:</strong><br />
    <input type="text" name="cm-472-472" id="l472-472" style="width: 100px;" /> <input type="submit" value="Subscribe" /></p>
  </form>
</div>

  </div>
    <div id="Footer">

    <p>Content copyright &copy;1999-2012 <a href="http://37signals.com">37signals, LLC.</a></p>
    
  <script type="text/javascript" charset="utf-8">
    document.observe("dom:loaded", function() {
      getTwitters('tweet', {
       id: '37signals',
       count: 3,
       enableLinks: true,
       ignoreReplies: true,
       clearContents: true,
       template: '%text% <a href="http://twitter.com/%user_screen_name%/statuses/%id%/">%time%</a>'
      });
    });
  </script>
   </div>
</div>
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-1876445-3";
urchinTracker();
</script>

<script type="text/javascript">
var clicky = { log: function(){ return; }, goal: function(){ return; }};
var clicky_site_id = 66390688;
(function() {
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = ( document.location.protocol == 'https:' ? 'https://static.getclicky.com/js' : 'http://static.getclicky.com/js' );
  ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s );
})();

</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="http://in.getclicky.com/66390688ns.gif" /></p></noscript>
<!-- Google Code for Visited SvN Remarketing List -->
<script type="text/javascript">
/* <![CDATA[ */
var google_conversion_id = 986221142;
var google_conversion_language = "en";
var google_conversion_format = "3";
var google_conversion_color = "666666";
var google_conversion_label = "7RE4CNLIgQMQ1pSi1gM";
var google_conversion_value = 0;
/* ]]> */
</script>
<script type="text/javascript" src="http://www.googleadservices.com/pagead/conversion.js">
</script>
<noscript>
<div style="display:inline;">
<img height="1" width="1" style="border-style:none;" alt="" src="http://www.googleadservices.com/pagead/conversion/986221142/?label=7RE4CNLIgQMQ1pSi1gM&amp;guid=ON&amp;script=0"/>
</div>
</noscript>

</body>
</html>

